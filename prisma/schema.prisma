
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- INFRASTRUCTURE ---

model Plantel {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  address     String   @db.Text
  lat         Float?
  lng         Float?
  isActive    Boolean  @default(true)

  jobs        Job[]

  // REVISED: Many-to-Many relation with Users
  users       User[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobTitle {
  id        String   @id @default(cuid())
  name      String   @unique
  category  String?
  isActive  Boolean  @default(true)
  jobs      Job[]
}

model ChecklistTemplate {
  id        String   @id @default(cuid())
  name      String
  type      String   @default("TEXT")
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
}

// --- RBAC ---

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  isGlobal    Boolean  @default(false)
  permissions String   @db.Text
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?

  roleId          String?
  role            Role?     @relation(fields: [roleId], references: [id], map: "fk_user_role")

  // REVISED: Many-to-Many. No longer a single string ID.
  plantels        Plantel[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  applications    Application[]
  comments        Comment[]
}

// --- BUSINESS ---

model Job {
  id          String   @id @default(cuid())
  title       String
  jobTitleId  String?
  jobTitle    JobTitle? @relation(fields: [jobTitleId], references: [id], map: "fk_job_title")
  description String   @db.Text
  department  String
  type        String   @default("Tiempo Completo")
  status      String   @default("OPEN")
  closingDate DateTime?
  plantelId   String
  plantel     Plantel  @relation(fields: [plantelId], references: [id], map: "fk_job_plantel")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications Application[]
}

model Application {
  id             String    @id @default(cuid())
  userId         String?
  user           User?     @relation(fields: [userId], references: [id], onDelete: SetNull, map: "fk_app_user")
  jobId          String
  job            Job       @relation(fields: [jobId], references: [id], onDelete: Cascade, map: "fk_app_job")

  fullName       String
  phone          String?
  email          String
  cvUrl          String?
  cvText         String?   @db.LongText

  status         String    @default("NEW")
  interviewStage Int       @default(0)
  isFavorite     Boolean   @default(false)
  interviewDate  DateTime?

  checklistValues ChecklistValue[]

  comments       Comment[]
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([jobId])
}

model ChecklistValue {
  id            String       @id @default(cuid())
  applicationId String
  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade, map: "fk_checklist_app")
  templateId    String
  value         String?      @db.Text
  updatedAt     DateTime     @updatedAt

  @@unique([applicationId, templateId])
}

model Comment {
  id            String      @id @default(cuid())
  text          String      @db.Text
  createdAt     DateTime    @default(now())
  userId        String
  user          User        @relation(fields: [userId], references: [id], map: "fk_comment_user")
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade, map: "fk_comment_app")

  @@index([applicationId])
}


/// ---- Notification Center Schema Snippet ----
/// Merge these models/enums into your main Prisma schema.prisma.
/// They reference existing models: User, Plantel, Job, JobTitle, Application.

enum NotificationType {
  NEW_APPLICATION
  STATUS_UPDATE
}

model Notification {
  id            String           @id @default(cuid())
  user          User             @relation(fields: [userId], references: [id])
  userId        String
  type          NotificationType
  title         String
  message       String
  link          String?
  createdAt     DateTime         @default(now())
  readAt        DateTime?

  // Optional context for richer UI
  application   Application?     @relation(fields: [applicationId], references: [id])
  applicationId String?
  job           Job?             @relation(fields: [jobId], references: [id])
  jobId         String?
  plantel       Plantel?         @relation(fields: [plantelId], references: [id])
  plantelId     String?
}

model NotificationPreference {
  id                  String   @id @default(cuid())
  user                User     @relation(fields: [userId], references: [id])
  userId              String

  // Scope: null = global; plantel- or puesto- specific overrides
  plantel             Plantel?  @relation(fields: [plantelId], references: [id])
  plantelId           String?
  jobTitle            JobTitle? @relation(fields: [jobTitleId], references: [id])
  jobTitleId          String?

  // Email channels
  emailNewEntries     Boolean  @default(true)
  emailStatusUpdates  Boolean  @default(true)

  // In-app notification center
  inAppNewEntries     Boolean  @default(true)
  inAppStatusUpdates  Boolean  @default(true)

  // Web Push channels
  pushNewEntries      Boolean  @default(false)
  pushStatusUpdates   Boolean  @default(false)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, plantelId, jobTitleId])
}

model PushSubscription {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  endpoint  String   @unique
  p256dh    String
  auth      String

  userAgent String?
  createdAt DateTime @default(now())
}