// --- prisma\schema.prisma ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Plantel {
  id          String   @id @default(cuid())
  name        String   
  code        String   @unique 
  address     String   @db.Text
  lat         Float?
  lng         Float?
  isActive    Boolean  @default(true)
  jobs        Job[]
  users       User[]   
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model JobTitle {
  id        String   @id @default(cuid())
  name      String   @unique 
  category  String?  
  isActive  Boolean  @default(true)
  jobs      Job[]
}

// NEW: Dynamic Checklist Configuration (Admin defines these)
model ChecklistTemplate {
  id        String   @id @default(cuid())
  name      String   // e.g. "Signia ID", "Entrevista Técnica", "Examen Médico"
  type      String   @default("TEXT") // TEXT, CHECKBOX, DATE
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  role            String    @default("CANDIDATE") 
  plantelId       String?
  plantel         Plantel?  @relation(fields: [plantelId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  applications    Application[]
  comments        Comment[] 
}

model Job {
  id          String   @id @default(cuid())
  title       String   
  jobTitleId  String?
  jobTitle    JobTitle? @relation(fields: [jobTitleId], references: [id])
  description String   @db.Text
  department  String
  type        String   @default("Tiempo Completo")
  status      String   @default("OPEN") 
  closingDate DateTime?
  plantelId   String
  plantel     Plantel @relation(fields: [plantelId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications Application[]
}

model Application {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  fullName    String
  phone       String?
  email       String   
  cvUrl       String?  
  cvText      String?  @db.LongText
  
  // Workflow
  status      String   @default("NEW") 
  interviewStage Int   @default(0)     
  isFavorite  Boolean  @default(false)
  interviewDate DateTime? 

  // NEW: Dynamic Values linking to ChecklistTemplate
  checklistValues ChecklistValue[]

  comments    Comment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt 
  
  @@index([userId])
  @@index([jobId])
}

// NEW: Stores the actual values for a specific candidate
model ChecklistValue {
  id          String   @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  templateId    String   // Links to ChecklistTemplate.id
  value         String?  @db.Text // Stores "12345" or "true" or "2023-01-01"

  updatedAt     DateTime @updatedAt
  
  @@unique([applicationId, templateId]) // One value per template per app
}

model Comment {
  id            String   @id @default(cuid())
  text          String   @db.Text
  createdAt     DateTime @default(now())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  @@index([applicationId])
}