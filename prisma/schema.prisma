// --- prisma\schema.prisma ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Plantel {
  id          String   @id @default(cuid())
  name        String   
  code        String   @unique 
  address     String   @db.Text
  lat         Float?
  lng         Float?
  isActive    Boolean  @default(true)
  
  jobs        Job[]
  users       User[]   
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// NEW: Standardized Job Titles (Puestos)
model JobTitle {
  id        String   @id @default(cuid())
  name      String   @unique // e.g. "Docente", "Intendencia"
  category  String?  // e.g. "Academico", "Administrativo"
  isActive  Boolean  @default(true)
  
  jobs      Job[]
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  role            String    @default("CANDIDATE") 
  
  plantelId       String?
  plantel         Plantel?  @relation(fields: [plantelId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  applications    Application[]
  comments        Comment[] 
}

model Job {
  id          String   @id @default(cuid())
  
  // REVISED: Link to JobTitle instead of free text
  // We keep 'title' as a snapshot string in case the Puesto is deleted later, 
  // but we prioritize the relation.
  title       String   
  jobTitleId  String?
  jobTitle    JobTitle? @relation(fields: [jobTitleId], references: [id])

  description String   @db.Text
  department  String
  type        String   @default("Tiempo Completo")
  status      String   @default("OPEN") 
  closingDate DateTime?
  
  plantelId   String
  plantel     Plantel @relation(fields: [plantelId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications Application[]
}

model Application {
  id          String   @id @default(cuid())
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  fullName    String
  phone       String?
  email       String   
  cvUrl       String?  
  cvText      String?  @db.LongText
  
  signiaId    String?
  evaId       String?
  pathId      String?
  
  // Statuses: NEW, INTERVIEW, TALENT_POOL, HIRED, REJECTED
  status      String   @default("NEW") 
  interviewStage Int   @default(0)     
  isFavorite  Boolean  @default(false)

  comments    Comment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt 
  
  @@index([userId])
  @@index([jobId])
}

model Comment {
  id            String   @id @default(cuid())
  text          String   @db.Text
  createdAt     DateTime @default(now())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}