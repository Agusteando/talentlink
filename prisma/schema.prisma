// --- prisma\schema.prisma ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// NEW: Dynamic Campus Management
model Plantel {
  id          String   @id @default(cuid())
  name        String   // Friendly name (e.g. "Campus Ecatepec")
  code        String   @unique // Short code (e.g. "PREET")
  address     String   @db.Text
  lat         Float?
  lng         Float?
  isActive    Boolean  @default(true)
  
  jobs        Job[]
  users       User[]   // Directors assigned specifically to this campus
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  role            String    @default("CANDIDATE") 
  
  // REVISED: Relation to Plantel instead of comma-separated string
  // If role is DIRECTOR, this links to their specific campus
  plantelId       String?
  plantel         Plantel?  @relation(fields: [plantelId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  applications    Application[]
  comments        Comment[] 
}

model Job {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  department  String
  type        String   @default("Tiempo Completo")
  status      String   @default("OPEN") 
  closingDate DateTime?
  
  // REVISED: Link to dynamic Plantel
  plantelId   String
  plantel     Plantel @relation(fields: [plantelId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  applications Application[]
}

model Application {
  id          String   @id @default(cuid())
  
  // REVISED: User is now OPTIONAL for Guest Apply
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  // Essential Contact Data (Stored directly for guests)
  fullName    String
  phone       String?
  email       String   // Mandatory for guests
  cvUrl       String?  
  cvText      String?  @db.LongText
  
  signiaId    String?
  evaId       String?
  pathId      String?
  
  status      String   @default("NEW") 
  interviewStage Int   @default(0)     
  
  comments    Comment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt 
  
  @@index([userId])
  @@index([jobId])
}

model Comment {
  id            String   @id @default(cuid())
  text          String   @db.Text
  createdAt     DateTime @default(now())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}